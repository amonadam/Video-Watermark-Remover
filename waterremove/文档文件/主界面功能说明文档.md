# 视频去水印软件主界面功能说明文档

## 1. 界面整体结构

主界面采用PyQt5构建，使用标签页（QTabWidget）进行模块化设计，包含三大功能区域：

- **视频处理标签页**：核心功能区域，用于视频选择、参数配置、水印检测和处理
- **历史记录标签页**：记录用户操作历史，支持筛选和管理
- **设置标签页**：软件参数设置，包括GPU加速、模型配置、ROI选择模式等

底部提供统一的操作按钮：开始处理、预览效果和退出。界面右侧为处理日志区域，实时显示操作状态和结果。

## 2. 核心功能模块详解

### 2.1 视频处理标签页

#### 2.1.1 输入视频选择
- **功能**：支持选择单个或多个视频文件，或选择包含视频的目录
- **组件**：
  - 输入路径文本框：显示已选择的视频文件路径
  - 选择文件按钮：打开文件选择对话框，支持多选
  - 选择目录按钮：打开目录选择对话框
- **操作**：点击按钮选择文件/目录后，路径会显示在文本框中，并记录到历史记录

#### 2.1.2 输出设置
- **功能**：配置视频处理后的保存位置和格式
- **组件**：
  - 输出路径文本框：默认值为"output"，可手动输入或浏览选择
  - 浏览按钮：打开目录选择对话框设置输出目录
  - 输出格式下拉框：支持MP4、AVI、MOV三种格式

#### 2.1.3 水印检测设置
- **功能**：配置水印检测算法参数，提高检测准确性
- **组件与参数**：
  - **采样帧数**（1-100，默认20）：从视频中采样的帧数，用于水印检测
  - **最小帧数**（1-50，默认10）：水印必须在多少帧中出现才被视为有效水印
  - **膨胀核大小**（1-20，默认3）：用于图像膨胀操作的核大小，调整水印区域的连通性
  - **启用颜色分割**（默认勾选）：使用蓝色背景检测优化水印识别
  - **最小连通域面积**（1-10000，默认100）：过滤掉过小的检测区域，减少误检

#### 2.1.4 预览选项
- **功能**：控制处理前是否预览效果
- **组件**：
  - 处理前预览效果复选框：默认勾选，处理前显示预览窗口

### 2.2 历史记录标签页

#### 2.2.1 历史记录管理
- **功能**：记录用户的导入和导出操作历史，支持筛选、分页和管理
- **组件**：
  - 操作类型筛选下拉框：支持筛选所有操作、导入或导出记录
  - 刷新按钮：重新加载历史记录
  - 清空历史按钮：删除所有历史记录（需确认）

#### 2.2.2 历史记录表格
- **功能**：以表格形式展示历史记录，包含以下列：
  - ID：记录唯一标识
  - 操作类型：导入或导出
  - 文件名：操作的文件名
  - 视频路径：文件的完整路径
  - 文件大小：格式化后的文件大小（如1.23 MB）
  - 操作时间：记录创建时间

#### 2.2.3 分页控制
- **功能**：支持分页查看历史记录
- **组件**：
  - 分页信息标签：显示当前页数和总页数
  - 上一页/下一页按钮：切换分页
  - 每页显示10条记录（可在代码中修改）

### 2.3 设置标签页

#### 2.3.1 硬件设置
- **功能**：配置GPU加速选项
- **组件**：
  - 使用GPU加速复选框：默认勾选，若检测到GPU则使用GPU加速
  - GPU信息标签：显示检测到的GPU信息或提示使用CPU

#### 2.3.2 模型设置
- **功能**：配置Lama修复模型参数
- **组件**：
  - LDM步数：控制修复质量（10-200，默认50）
  - 高清策略：支持ORIGINAL（原始）、CROP（裁剪）、RESIZE（缩放）三种策略

#### 2.3.3 其他设置
- **功能**：配置ROI选择模式和其他高级选项
- **组件**：
  - **水印区域选择模式**：
    - 手动选择水印区域：用户手动框选水印位置
    - 自动检测水印区域：软件自动检测水印位置（默认）
  - **ROI边距**：控制水印区域的扩展范围（0-100像素，默认50）

#### 2.3.4 设置保存
- **功能**：保存当前设置，下次启动自动加载
- **组件**：
  - 保存设置按钮：将当前设置保存到配置文件

## 3. 核心操作流程

### 3.1 视频处理流程
1. **选择视频**：通过"选择文件"或"选择目录"按钮添加视频
2. **配置参数**：根据需要调整水印检测和处理参数
3. **预览效果**（可选）：点击"预览效果"查看处理效果
4. **开始处理**：点击"开始处理"按钮启动视频处理
5. **查看结果**：处理完成后，在输出目录查看处理后的视频

### 3.2 预览流程
1. 选择视频并配置参数
2. 点击"预览效果"按钮
3. 系统自动检测或手动选择水印区域
4. 查看修复效果预览
5. 确认后返回主界面

### 3.3 设置管理流程
1. 切换到"设置"标签页
2. 调整需要修改的参数
3. 点击"保存设置"按钮
4. 系统提示保存成功，设置将在下次启动时生效

## 4. 技术实现细节

### 4.1 水印检测算法
- **核心原理**：结合颜色分割和边缘检测技术识别水印区域
- **关键参数**：
  - 采样帧数：控制检测的样本量
  - 最小帧数：确保水印的稳定性
  - 膨胀核大小：调整水印区域的连通性
  - 最小连通域面积：过滤噪声区域

### 4.2 用户权限管理
- **权限级别**：
  - edit权限：可进行视频处理和预览
  - admin权限：可修改软件设置
- **实现**：基于角色的权限控制，动态启用/禁用UI控件

### 4.3 多线程处理
- **技术**：使用QThread实现视频处理与UI交互分离
- **优势**：避免处理大文件时界面卡顿
- **实现**：ProcessingThread类处理视频任务，主线程更新进度

### 4.4 数据持久化
- **技术**：使用SQLite数据库存储用户操作历史
- **功能**：支持分页查询、筛选、删除等操作
- **实现**：通过history_manager模块提供的API进行数据操作

### 4.5 模型集成
- **水印检测模型**：WatermarkDetector类，实现自动水印区域检测
- **图像修复模型**：LamaInpainter类，支持GPU加速的高质量图像修复
- **回退机制**：当Lama模型不可用时，自动切换到OpenCV修复算法

## 5. 日志与错误处理

- **日志系统**：右侧日志区域实时显示操作状态和结果
- **错误处理**：操作失败时显示详细错误信息，包括文件选择错误、模型初始化失败、处理失败等
- **用户提示**：使用QMessageBox提供友好的操作提示和错误信息

## 6. 权限控制

根据用户权限动态启用/禁用UI控件：
- **有edit权限**：可使用所有视频处理功能（选择文件、预览、开始处理）
- **无edit权限**：视频处理相关控件被禁用
- **有admin权限**：可修改软件设置
- **无admin权限**：设置相关控件被禁用

## 7. 界面交互细节

- **实时反馈**：操作后立即在日志区域显示结果
- **参数验证**：处理前验证输入参数的有效性
- **进度显示**：处理过程中显示进度对话框
- **自动加载设置**：启动时自动加载上次保存的设置

# 总结

本软件提供了完整的视频水印检测和去除功能，界面友好，参数配置灵活。通过模块化设计，将复杂的视频处理流程分解为易于操作的步骤，同时提供详细的日志和错误处理机制，确保用户能够高效、稳定地完成视频去水印任务。